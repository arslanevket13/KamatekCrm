<Window x:Class="KamatekCrm.Views.ProjectQuoteEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:KamatekCrm.ViewModels"
        xmlns:dd="urn:gong-wpf-dragdrop"
        Title="ðŸ—ï¸ PROJE TEKLÄ°F EDÄ°TÃ–RÃœ" 
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="#F5F5F5">
    
    <Window.DataContext>
        <vm:ProjectQuoteEditorViewModel/>
    </Window.DataContext>
    
    <Window.Resources>
        <!-- TreeView Item Template -->
        <HierarchicalDataTemplate x:Key="TreeNodeTemplate" ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal" Margin="2">
                <TextBlock Text="{Binding HeaderDisplay}" FontSize="13" VerticalAlignment="Center"/>
            </StackPanel>
        </HierarchicalDataTemplate>
        
        <!-- Product List Template -->
        <DataTemplate x:Key="ProductTemplate">
            <Border Background="White" CornerRadius="4" Padding="10,8" Margin="2"
                    BorderBrush="#E0E0E0" BorderThickness="1" Cursor="Hand">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding ProductName}" FontWeight="SemiBold" FontSize="12"
                                   TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="{Binding SKU}" FontSize="10" Foreground="#757575"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="{Binding SalePrice, StringFormat='â‚º{0:N0}'}" 
                               FontWeight="Bold" Foreground="#4CAF50" VerticalAlignment="Center"/>
                </Grid>
            </Border>
        </DataTemplate>
    </Window.Resources>
    
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="#1565C0" CornerRadius="8" Padding="20,15" Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0">
                    <TextBlock Text="ðŸ—ï¸ PROJE TEKLÄ°F EDÄ°TÃ–RÃœ" 
                               FontSize="22" FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text="Profesyonel MÃ¼hendislik TezgahÄ± - YapÄ± AÄŸacÄ±, Mahal Listesi, ÃœrÃ¼n KataloÄŸu" 
                               FontSize="12" Foreground="#E3F2FD" Margin="0,5,0,0"/>
                </StackPanel>
                
                <!-- Proje Kodu -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding CurrentProject.ProjectCode}" FontSize="16" 
                               FontWeight="Bold" Foreground="White" Margin="0,0,20,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Proje Bilgileri Bar -->
        <Border Grid.Row="1" Background="White" CornerRadius="6" Padding="15" Margin="0,0,0,10"
                BorderBrush="#E0E0E0" BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="250"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- MÃ¼ÅŸteri -->
                <StackPanel Grid.Column="0" Margin="0,0,15,0">
                    <TextBlock Text="MÃœÅžTERÄ°" FontWeight="SemiBold" FontSize="10" 
                               Foreground="#757575" Margin="0,0,0,5"/>
                    <ComboBox ItemsSource="{Binding Customers}"
                              SelectedItem="{Binding SelectedCustomer}"
                              DisplayMemberPath="FullName"
                              Height="32"/>
                </StackPanel>
                
                <!-- Proje AdÄ± -->
                <StackPanel Grid.Column="1" Margin="0,0,15,0">
                    <TextBlock Text="PROJE ADI" FontWeight="SemiBold" FontSize="10" 
                               Foreground="#757575" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding ProjectName, UpdateSourceTrigger=PropertyChanged}"
                             Height="32" Padding="8,6"/>
                </StackPanel>
                
                <!-- YapÄ± OluÅŸturucu -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Bottom">
                    <StackPanel Margin="0,0,10,0">
                        <TextBlock Text="Blok" FontSize="10" Foreground="#757575"/>
                        <TextBox Text="{Binding BlockCount}" Width="50" Height="32" 
                                 TextAlignment="Center" Padding="5"/>
                    </StackPanel>
                    <StackPanel Margin="0,0,10,0">
                        <TextBlock Text="Kat" FontSize="10" Foreground="#757575"/>
                        <TextBox Text="{Binding FloorCount}" Width="50" Height="32" 
                                 TextAlignment="Center" Padding="5"/>
                    </StackPanel>
                    <StackPanel Margin="0,0,10,0">
                        <TextBlock Text="Daire/Kat" FontSize="10" Foreground="#757575"/>
                        <TextBox Text="{Binding FlatsPerFloor}" Width="50" Height="32" 
                                 TextAlignment="Center" Padding="5"/>
                    </StackPanel>
                    <Button Content="ðŸ—ï¸ YAPI OLUÅžTUR" Command="{Binding GenerateStructureCommand}"
                            Background="#FF9800" Foreground="White" FontWeight="SemiBold"
                            Padding="15,8" BorderThickness="0" Height="32" Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Ana Ä°Ã§erik (3 Panel) -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="200"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="*" MinWidth="300"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="300" MinWidth="250"/>
            </Grid.ColumnDefinitions>
            
            <!-- SOL PANEL: YapÄ± AÄŸacÄ± -->
            <Border Grid.Column="0" Background="White" CornerRadius="8" 
                    BorderBrush="#E0E0E0" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- BaÅŸlÄ±k -->
                    <Border Grid.Row="0" Background="#E3F2FD" Padding="12,10">
                        <TextBlock Text="ðŸ“ YAPI AÄžACI" FontWeight="Bold" FontSize="13" Foreground="#1565C0"/>
                    </Border>
                    
                    <!-- TreeView -->
                    <TreeView Grid.Row="1" ItemsSource="{Binding RootNodes}"
                              ItemTemplate="{StaticResource TreeNodeTemplate}"
                              BorderThickness="0" Padding="5"
                              SelectedItemChanged="TreeView_SelectedItemChanged">
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem">
                                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                <Setter Property="Padding" Value="3"/>
                            </Style>
                        </TreeView.ItemContainerStyle>
                        
                        <!-- Context Menu -->
                        <TreeView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="âž• Blok Ekle" Command="{Binding AddBlockCommand}"/>
                                <MenuItem Header="ðŸ“‹ Kat Ekle" Command="{Binding AddFloorCommand}"/>
                                <MenuItem Header="ðŸ  Daire Ekle" Command="{Binding AddFlatCommand}"/>
                                <MenuItem Header="ðŸ­ BÃ¶lge Ekle" Command="{Binding AddZoneCommand}"/>
                                <Separator/>
                                <MenuItem Header="ðŸ“‘ Kopyala (Duplicate)" Command="{Binding DuplicateNodeCommand}"/>
                                <MenuItem Header="ðŸ“ Yeniden AdlandÄ±r / Etiketle" Command="{Binding RenameNodeCommand}"/>
                                <MenuItem Header="ðŸ“‹ KardeÅŸlere Uygula" Command="{Binding ApplyToSiblingsCommand}"/>
                                <Separator/>
                                <MenuItem Header="ðŸ—‘ï¸ Sil" Command="{Binding RemoveNodeCommand}" Foreground="Red"/>
                            </ContextMenu>
                        </TreeView.ContextMenu>
                    </TreeView>
                    
                    <!-- Tree ButonlarÄ± -->
                    <Border Grid.Row="2" Background="#FAFAFA" Padding="8" 
                            BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                        <WrapPanel>
                            <Button Content="âž• Blok" Command="{Binding AddBlockCommand}"
                                    Margin="2" Padding="8,4" FontSize="11"/>
                            <Button Content="ðŸ“‹ Kat" Command="{Binding AddFloorCommand}"
                                    Margin="2" Padding="8,4" FontSize="11"/>
                            <Button Content="ðŸ  Daire" Command="{Binding AddFlatCommand}"
                                    Margin="2" Padding="8,4" FontSize="11"/>
                        </WrapPanel>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Splitter 1 -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Stretch" 
                          Background="Transparent" Cursor="SizeWE"/>
            
            <!-- ORTA PANEL: Mahal Listesi -->
            <Border Grid.Column="2" Background="White" CornerRadius="8" 
                    BorderBrush="#E0E0E0" BorderThickness="1"
                    dd:DragDrop.IsDropTarget="True"
                    dd:DragDrop.DropHandler="{Binding}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- BaÅŸlÄ±k -->
                    <Border Grid.Row="0" Background="#E8F5E9" Padding="12,10">
                        <Grid>
                            <TextBlock Text="{Binding SelectedNodeName, StringFormat='ðŸ› ï¸ {0} - Kalem Listesi'}" 
                                       FontWeight="Bold" FontSize="13" Foreground="#2E7D32"/>
                            <TextBlock Text="{Binding SelectedNodeSubTotal, StringFormat='â‚º{0:N0}'}" 
                                       HorizontalAlignment="Right" FontWeight="Bold" 
                                       FontSize="14" Foreground="#4CAF50"/>
                        </Grid>
                    </Border>
                    
                    <!-- DataGrid -->
                    <DataGrid Grid.Row="1" ItemsSource="{Binding CurrentNodeItems}"
                              SelectedItem="{Binding SelectedItem}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              BorderThickness="0"
                              GridLinesVisibility="Horizontal"
                              HeadersVisibility="Column"
                              RowHeaderWidth="0"
                              SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="ÃœrÃ¼n" Binding="{Binding ProductName}" Width="*" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Adet" Binding="{Binding Quantity}" Width="60"/>
                            <DataGridTextColumn Header="AlÄ±ÅŸ â‚º" Binding="{Binding UnitCost, StringFormat='{}{0:N0}'}" Width="80">
                                <DataGridTextColumn.CellStyle>
                                    <Style TargetType="DataGridCell">
                                        <Setter Property="Foreground" Value="#757575"/>
                                    </Style>
                                </DataGridTextColumn.CellStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="SatÄ±ÅŸ â‚º" Binding="{Binding UnitPrice, StringFormat='{}{0:N0}'}" Width="80"/>
                            <DataGridTextColumn Header="Ä°ÅŸÃ§ilik â‚º" Binding="{Binding LaborCost, StringFormat='{}{0:N0}'}" Width="80"/>
                            <DataGridTextColumn Header="Toplam â‚º" Binding="{Binding TotalPrice, StringFormat='{}{0:N0}'}" Width="90" IsReadOnly="True">
                                <DataGridTextColumn.CellStyle>
                                    <Style TargetType="DataGridCell">
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Style>
                                </DataGridTextColumn.CellStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Marj" Binding="{Binding MarginDisplay}" Width="60" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="Ops." Binding="{Binding IsOptional}" Width="40"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- Alt Bar -->
                    <Border Grid.Row="2" Background="#FAFAFA" Padding="10" 
                            BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                        <Grid>
                            <Button Content="ðŸ—‘ï¸ Kalemi Sil" Command="{Binding RemoveItemCommand}"
                                    Background="#EF5350" Foreground="White" 
                                    Padding="12,6" BorderThickness="0" HorizontalAlignment="Left"/>
                            
                            <TextBlock Text="ðŸ’¡ SaÄŸ panelden Ã¼rÃ¼n sÃ¼rÃ¼kleyip bÄ±rakÄ±n" 
                                       FontSize="11" Foreground="#9E9E9E" 
                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Splitter 2 -->
            <GridSplitter Grid.Column="3" Width="5" HorizontalAlignment="Stretch" 
                          Background="Transparent" Cursor="SizeWE"/>
            
            <!-- SAÄž PANEL: ÃœrÃ¼n KataloÄŸu -->
            <Border Grid.Column="4" Background="White" CornerRadius="8" 
                    BorderBrush="#E0E0E0" BorderThickness="1">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- BaÅŸlÄ±k -->
                    <Border Grid.Row="0" Background="#FFF3E0" Padding="12,10">
                        <TextBlock Text="ðŸ“¦ ÃœRÃœN &amp; HÄ°ZMET KATALOÄžU" FontWeight="Bold" 
                                   FontSize="13" Foreground="#E65100"/>
                    </Border>
                    
                    <!-- Arama -->
                    <Border Grid.Row="1" Padding="10,8">
                        <TextBox Text="{Binding ProductSearchText, UpdateSourceTrigger=PropertyChanged}"
                                 Height="32" Padding="30,6,8,6"/>
                    </Border>
                    
                    <!-- ÃœrÃ¼n Listesi -->
                    <ListBox Grid.Row="2" ItemsSource="{Binding FilteredProducts}"
                             SelectedItem="{Binding SelectedProduct}"
                             ItemTemplate="{StaticResource ProductTemplate}"
                             BorderThickness="0" Padding="5"
                             dd:DragDrop.IsDragSource="True"
                             dd:DragDrop.DragAdornerTemplate="{StaticResource ProductTemplate}"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Margin" Value="0"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                    
                    <!-- Ekle Butonu -->
                    <Border Grid.Row="3" Background="#FAFAFA" Padding="10" 
                            BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                        <Button Content="âž• SEÃ‡Ä°LÄ° NODE'A EKLE" Command="{Binding AddItemCommand}"
                                Background="#4CAF50" Foreground="White" FontWeight="SemiBold"
                                Padding="10,8" BorderThickness="0" Cursor="Hand"
                                HorizontalAlignment="Stretch"/>
                    </Border>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Footer: Finansal Ã–zet ve Butonlar -->
        <Border Grid.Row="3" Background="White" CornerRadius="8" Padding="15" Margin="0,10,0,0"
                BorderBrush="#E0E0E0" BorderThickness="1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Finansal Ã–zet -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Maliyet -->
                    <Border Background="#FFEBEE" CornerRadius="6" Padding="15,10" Margin="0,0,15,0">
                        <StackPanel>
                            <TextBlock Text="MALÄ°YET" FontSize="10" Foreground="#C62828"/>
                            <TextBlock Text="{Binding TotalCostDisplay}" FontSize="18" 
                                       FontWeight="Bold" Foreground="#D32F2F"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- SatÄ±ÅŸ -->
                    <Border Background="#E3F2FD" CornerRadius="6" Padding="15,10" Margin="0,0,15,0">
                        <StackPanel>
                            <TextBlock Text="SATIÅž" FontSize="10" Foreground="#1565C0"/>
                            <TextBlock Text="{Binding TotalRevenueDisplay}" FontSize="18" 
                                       FontWeight="Bold" Foreground="#1976D2"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Kar -->
                    <Border Background="#E8F5E9" CornerRadius="6" Padding="15,10" Margin="0,0,15,0">
                        <StackPanel>
                            <TextBlock Text="KAR" FontSize="10" Foreground="#2E7D32"/>
                            <TextBlock Text="{Binding TotalProfitDisplay}" FontSize="18" 
                                       FontWeight="Bold" Foreground="#388E3C"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Marj -->
                    <Border Background="#FFF8E1" CornerRadius="6" Padding="15,10">
                        <StackPanel>
                            <TextBlock Text="MARJ" FontSize="10" Foreground="#F57C00"/>
                            <TextBlock Text="{Binding OverallMarginDisplay}" FontSize="18" 
                                       FontWeight="Bold" Foreground="#EF6C00"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
                
                <!-- Butonlar -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="âŒ Ä°PTAL" 
                            Command="{Binding CancelCommand}"
                            CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=Window}}"
                            Background="#9E9E9E" Foreground="White"
                            FontWeight="SemiBold" Padding="25,12"
                            Margin="0,0,10,0" BorderThickness="0" Cursor="Hand"/>
                    
                    <Button Content="ðŸ“ PDF DIÅžA AKTAR" 
                            Command="{Binding ExportPdfCommand}"
                            Background="#FF9800" Foreground="White"
                            FontWeight="SemiBold" Padding="25,12"
                            Margin="0,0,10,0" BorderThickness="0" Cursor="Hand"/>

                    <Button Content="ðŸ“§ E-POSTA GÃ–NDER" 
                            Command="{Binding SendEmailCommand}"
                            Background="#2196F3" Foreground="White"
                            FontWeight="SemiBold" Padding="25,12"
                            Margin="0,0,10,0" BorderThickness="0" Cursor="Hand"/>

                    <Button Content="ðŸ’¾ KAYDET" 
                            Command="{Binding SaveCommand}"
                            Background="#4CAF50" Foreground="White"
                            FontWeight="Bold" FontSize="14" Padding="35,12"
                            BorderThickness="0" Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
