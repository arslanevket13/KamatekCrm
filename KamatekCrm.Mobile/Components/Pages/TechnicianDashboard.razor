@page "/dashboard"
@using KamatekCrm.Shared.DTOs
@using System.Net.Http.Json
@using System.Net.Http.Headers
@inject HttpClient Http
@inject NavigationManager Nav

<div class="container-fluid py-3" style="padding-bottom: 80px;">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="fw-bold mb-0">Hoş Geldin, @userName</h5>
            <small class="text-muted">Bugünkü işlerin aşağıda listeleniyor</small>
        </div>
        <button class="btn btn-outline-primary btn-sm" @onclick="LoadJobs">
            <i class="oi oi-reload"></i>
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2 text-muted">İşler yükleniyor...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            <i class="oi oi-warning me-2"></i>@errorMessage
            <button class="btn btn-sm btn-outline-danger ms-2" @onclick="LoadJobs">Tekrar Dene</button>
        </div>
    }
    else if (jobs == null || jobs.Count == 0)
    {
        <div class="text-center py-5">
            <i class="oi oi-check text-success" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Harika!</h5>
            <p class="text-muted">Şu an bekleyen işin yok.</p>
        </div>
    }
    else
    {
        @foreach (var job in jobs)
        {
            <div class="card mb-3 shadow-sm border-start border-4 @GetPriorityBorderClass(job.Priority)">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1">@job.Title</h6>
                            <p class="mb-1 text-muted small">
                                <i class="oi oi-person me-1"></i>@job.CustomerName
                            </p>
                            <p class="mb-0 text-muted small">
                                <i class="oi oi-map-marker me-1"></i>@job.Address
                            </p>
                        </div>
                        <span class="badge @GetStatusBadgeClass(job.Status)">@GetStatusText(job.Status)</span>
                    </div>

                    <hr class="my-2">

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="oi oi-calendar me-1"></i>@job.Date.ToString("dd MMM, HH:mm")
                        </small>
                        <div>
                            @if (job.CustomerPhone != null)
                            {
                                <a href="tel:@job.CustomerPhone" class="btn btn-sm btn-outline-success me-1">
                                    <i class="oi oi-phone"></i>
                                </a>
                            }
                            <button class="btn btn-sm btn-primary" @onclick="() => OpenJobDetail(job.Id)">
                                Detay <i class="oi oi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<TechnicianJobDto>? jobs;
    private bool isLoading = true;
    private string? errorMessage;
    private string userName = "Teknisyen";

    protected override async Task OnInitializedAsync()
    {
        var token = await SecureStorage.GetAsync("auth_token");
        if (string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/");
            return;
        }

        userName = await SecureStorage.GetAsync("user_name") ?? "Teknisyen";
        await LoadJobs();
    }

    private async Task LoadJobs()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var token = await SecureStorage.GetAsync("auth_token");
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            jobs = await Http.GetFromJsonAsync<List<TechnicianJobDto>>("api/technician/my-jobs");
        }
        catch (HttpRequestException)
        {
            errorMessage = "Sunucuya bağlanılamadı.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Hata: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenJobDetail(int id)
    {
        Nav.NavigateTo($"/job/{id}");
    }

    private string GetPriorityBorderClass(string priority) => priority switch
    {
        "Critical" => "border-danger",
        "Urgent" => "border-warning",
        "Normal" => "border-info",
        _ => "border-secondary"
    };

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Pending" => "bg-warning text-dark",
        "InProgress" => "bg-primary",
        "Completed" => "bg-success",
        "Cancelled" => "bg-secondary",
        _ => "bg-light text-dark"
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "Bekliyor",
        "InProgress" => "Devam Ediyor",
        "Completed" => "Tamamlandı",
        "Cancelled" => "İptal",
        _ => status
    };
}