@page "/login"
@using KamatekCrm.Web.Services
@using KamatekCrm.Shared.DTOs
@using KamatekCrm.Web.Components.Layout
@layout LoginLayout
@inject ApiAuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center justify-center mud-width-full" Style="height: 100vh;">
    <MudPaper Elevation="25" Class="pa-8" Width="100%" MaxWidth="400px">
        <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true" Color="Color.Primary"><b>Kamatek</b> CRM</MudText>
        <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">Giriş Yap</MudText>

        <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            
            <MudTextField T="string" Label="Kullanıcı Adı" Variant="Variant.Outlined"
                          @bind-Value="loginModel.Username" For="@(() => loginModel.Username)" 
                          Class="mb-4" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" />

            <MudTextField T="string" Label="Şifre" Variant="Variant.Outlined"
                          @bind-Value="loginModel.Password" For="@(() => loginModel.Password)" 
                          InputType="InputType.Password" 
                          Class="mb-6" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Lock" />

            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" 
                       Size="Size.Large" FullWidth="true" Disabled="_processing">
                @if (_processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Giriş Yapılıyor...</MudText>
                }
                else
                {
                    <MudText>Giriş Yap</MudText>
                }
            </MudButton>
        </EditForm>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private LoginRequest loginModel = new LoginRequest();
    private bool _processing = false;
    private string _errorMessage = "";

    private async Task HandleLogin()
    {
        _processing = true;
        _errorMessage = "";
        StateHasChanged();

        try
        {
            var result = await AuthStateProvider.LoginAsync(loginModel);
            if (result.Success)
            {
                Snackbar.Add("Giriş Başarılı!", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                _errorMessage = result.Message ?? "Kullanıcı adı veya şifre hatalı.";
                Snackbar.Add(_errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _errorMessage = "Sunucu bağlantı hatası: " + ex.Message;
            Snackbar.Add("API'ye ulaşılamıyor (Port 5050 kontrol edin)", Severity.Error);
        }
        finally
        {
            _processing = false;
            StateHasChanged();
        }
    }
}