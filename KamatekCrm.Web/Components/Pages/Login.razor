@using MudBlazor
@using KamatekCrm.Shared.DTOs
@inject HttpClient Http
@inject NavigationManager Navigation
@inject KamatekCrm.Web.Services.ApiAuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

@page "/login"

<PageTitle>Giriş - Kamatek ERP</PageTitle>

<MudThemeProvider />
<MudPopoverProvider />
<MudSnackbarProvider />

<div class="d-flex align-center justify-center"
     style="height: 100vh; background: linear-gradient(135deg, #1A237E 0%, #3949AB 100%);">
    <MudCard Style="width: 400px;" Elevation="8">
        <MudCardHeader>
            <CardHeaderContent>
                <div class="d-flex flex-column align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Primary"
                             Class="mb-2" />
                    <MudText Typo="Typo.h5" Color="Color.Primary">Kamatek ERP</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Yönetim Paneli</MudText>
                </div>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudForm @ref="_form" @bind-IsValid="_formValid">
                <MudTextField @bind-Value="_username" Label="Kullanıcı Adı" Variant="Variant.Outlined"
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person" Required="true"
                              RequiredError="Kullanıcı adı gerekli" Class="mb-3" />
                <MudTextField @bind-Value="_password" Label="Şifre" Variant="Variant.Outlined"
                              InputType="InputType.Password" Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock" Required="true" RequiredError="Şifre gerekli"
                              Class="mb-3" />
            </MudForm>
        </MudCardContent>
        <MudCardActions Class="d-flex flex-column pa-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                       Disabled="@(_isLoading || !_formValid)" OnClick="HandleLogin">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Giriş yapılıyor...</span>
                }
                else
                {
                    <span>Giriş Yap</span>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>
</div>

@code {
    private MudForm _form = null!;
    private bool _formValid;
    private bool _isLoading;
    private string _username = "";
    private string _password = "";

    private async Task HandleLogin()
    {
        if (!_formValid) return;

        _isLoading = true;
        try
        {
            var response = await Http.PostAsJsonAsync("api/auth/login", new LoginRequest
            {
                Username = _username,
                Password =
_password
            });
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                if (result != null)
                {
                    await AuthStateProvider.MarkUserAsAuthenticated(result.Token);
                    Navigation.NavigateTo("/");
                }
            }
            else
            {
                Snackbar.Add("Kullanıcı adı veya şifre hatalı!", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Bağlantı hatası: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }
}